set -x
set -e

export LC_ALL=C

source /common.sh
install_cleanup_trap

# already done, so we don't need to do anything
grep -q "camera_libcamera_options" /boot/octopi.txt && exit 0

# new octopi.txt
cp /files/octopi.txt /boot/octopi.txt

# new webcamd
cp /files/webcamd /root/bin/webcamd
chmod +x /root/bin/webcamd

# enable camera auto detect and slightly increase gpu mem
sed -i 's/^camera_auto_detect=0/camera_auto_detect=1/' /boot/config.txt
sed -i 's/^gpu_mem=128/gpu_mem=200/' /boot/config.txt

# update error page
if grep -q "camera_usb_options" /etc/haproxy/errors/503-no-webcam.http; then
    sed -i 's/camera_usb_options/camera_uvc_options/g' /etc/haproxy/errors/503-no-webcam.http
fi
